# This file contains linux-specific Makefile includes that contain building
# instructions for binaries and packages.

# Linux-specific includes

INCLUDES += -I$(BITMUNK)/build/apps/firefox/components -I$(BITMUNK)/dist/internal/include @GTK_INCLUDES@

#required for ubuntu build:
#INCLUDES += -I/usr/include/nspr

# Linux-specific variables
LINUX_CXX = @LINUX_CXX@
LINUX_CXX_FLAGS = @CXXFLAGS@ -march=i686 -Wall -fPIC $(MODULE_LINUX_CXX_FLAGS) -DBITMUNK_PLATFORM_LINUX @DEFS@
LINUX_LD_FLAGS = @LDFLAGS@ -Wl,-rpath=@BITMUNK_MODULES_DIR@
LINUX_INCLUDES = $(INCLUDES)
LINUX_DBLIB_DIR = $(MONARCH)/dist/lib
LINUX_LIBS = -L$(LINUX_DBLIB_DIR) -L$(LINUX_LIB_DIR) -L/usr/lib/mysql @GTK_LIBS@
LINUX_AR = @LINUX_AR@
LINUX_BUILD_DIR = $(BITMUNK)/build/$(subst $(BITMUNK)/cpp/,,$(CWD))
LINUX_DIST_DIR = $(BITMUNK)/dist
LINUX_LIB_DIR = $(LINUX_DIST_DIR)/lib
LINUX_BIN_DIR = $(LINUX_DIST_DIR)/bin
LINUX_XPT_DIR = $(LINUX_DIST_DIR)/xpt
LINUX_XPI_DIR = $(LINUX_DIST_DIR)/xpi
LINUX_MODULES_DIR = $(LINUX_DIST_DIR)/modules
LINUX_HEADER_FILES := $(patsubst %.h, $(BITMUNK)/$(HEADER_DIST_DIR)/%.h, $(HEADERS))
LINUX_LIBRARY_SOURCES := $(patsubst %.cpp,$(LINUX_BUILD_DIR)/%.cpp, $(SOURCES))
LINUX_EXECUTABLE_SOURCES := $(patsubst %,$(LINUX_BUILD_DIR)/%.cpp, $(EXECUTABLES))
LIBRARY_OBJECTS := $(patsubst %.cpp,$(LINUX_BUILD_DIR)/%-linux.o, $(SOURCES))
EXECUTABLE_OBJECTS := $(patsubst %,$(LINUX_BUILD_DIR)/%-linux.o, $(EXECUTABLES))
DYNAMIC_LINUX_LIBRARIES := $(DYNAMIC_LINK_LIBRARIES) $(DYNAMIC_LINUX_LIBRARIES)
LINUX_EXECUTABLES := $(patsubst %,$(LINUX_BIN_DIR)/%, $(EXECUTABLES))
LINUX_DEPENDENCIES := $(patsubst %.cpp,$(LINUX_BUILD_DIR)/%-linux.P, $(SOURCES))
LINUX_DEPENDENCIES += $(patsubst %.cpp,%-linux.P, $(LINUX_EXECUTABLE_SOURCES))

LINUX_LIBRARIES := $(patsubst %,$(LINUX_LIB_DIR)/lib%.so, $(LIBRARIES)) 
LINUX_LIBRARIES += $(patsubst %,$(LINUX_LIB_DIR)/lib%.so, $(COMPONENT_LIBRARIES))
#LINUX_LIBRARIES += $(patsubst %,$(LINUX_LIB_DIR)/lib%.a, $(LIBRARIES))

ALL_GENERATED_HEADERS := $(patsubst %.idl,$(LINUX_BUILD_DIR)/%.h, $(IDL_SOURCES))
ALL_XPTS := $(patsubst %.idl,$(LINUX_XPT_DIR)/%.xpt, $(IDL_SOURCES))

ALL_HEADERS += $(LINUX_HEADER_FILES)
ALL_SOURCES += $(LINUX_LIBRARY_SOURCES) $(LINUX_EXECUTABLE_SOURCES)
ALL_OBJECTS += $(LIBRARY_OBJECTS) $(EXECUTABLE_OBJECTS)
ALL_LIBRARIES += $(LINUX_LIBRARIES)
ALL_EXECUTABLES += $(LINUX_EXECUTABLES)
ALL_DIRECTORIES += $(LINUX_BUILD_DIR) $(LINUX_DIST_DIR) $(LINUX_LIB_DIR) $(LINUX_BIN_DIR) $(LINUX_MODULES_DIR) $(LINUX_XPT_DIR) $(LINUX_XPI_DIR)

ifndef IGNORE_DEPENDENCIES
-include $(LINUX_DEPENDENCIES)
endif

$(LINUX_HEADER_FILES): 
	$(PCMD) mkdir -p $(dir $@)
	$(PCMD) ln -sf $(subst $(BITMUNK)/$(HEADER_DIST_DIR)/,$(CWD)/,$@) $@

# You can build either multiple executables per directory, or multiple
# libraries per directory, but not both.
ifdef EXECUTABLES
$(LINUX_EXECUTABLE_SOURCES):
	$(PCMD) mkdir -p $(dir $@)
	$(PCMD) ln -sf $(subst $(LINUX_BUILD_DIR)/,$(CWD)/,$@) $@
else
$(LINUX_LIBRARY_SOURCES):
	$(PCMD) mkdir -p $(dir $@)
	$(PCMD) ln -sf $(subst $(LINUX_BUILD_DIR)/,$(CWD)/,$@) $@
endif

$(LINUX_BUILD_DIR)/%.h: %.idl
	@echo "Building $@..."
	$(PCMD) $(XPIDL) -m header $(XULIDL_INCLUDES)  -o $(basename $@) $<

$(LINUX_XPT_DIR)/%.xpt: %.idl
	@echo "Generating dist/$(subst .P,.o,$(subst $(BITMUNK)/dist/,,$@))..."
	$(PCMD) $(XPIDL) -m typelib $(XULIDL_INCLUDES) -o $(basename $@) $<

%-linux.o %-linux.P: %.cpp $(ALL_GENERATED_HEADERS)
	@echo "Compiling build/$(subst .P,.o,$(subst $(BITMUNK)/build/,,$@))..."
	$(PCMD) $(LINUX_CXX) $(LINUX_CXX_FLAGS) -c -MD -o $(basename $@).o $(LINUX_INCLUDES) -I. $(realpath $<)
	$(PCMD) cp $(basename $@).d $(basename $@).P; \
		sed -e 's/#.*//' -e 's/^[^:]*: *//' -e 's/ *\\$$//' -e '/^$$/ d' -e 's/$$/ :/' < $(basename $@).d >> $(basename $@).P; \
		rm -f $(basename $@).d

%.so: $(LIBRARY_OBJECTS)
	@echo "Linking $(subst $(BITMUNK)/,,$@)..."
	$(PCMD) $(LINUX_CXX) $(LINUX_LD_FLAGS) $(LINUX_LIBS) -shared -o $@ $(LIBRARY_OBJECTS) $(DYNAMIC_LINUX_LIBRARIES:%=-l%)

#%.a: $(LIBRARY_OBJECTS)
#	@echo "Creating $(subst $(BITMUNK)/,,$@) archive..."
#	$(PCMD) $(LINUX_AR) $(AR_FLAGS) $@ $(LIBRARY_OBJECTS)

ifdef EXECUTABLES
$(LINUX_EXECUTABLES): $(LINUX_BUILD_DIR)/$$(@F)-linux.o $(STATIC_LINUX_LIBRARIES)
	@echo "Linking dist/bin/$(@F)..."
	$(PCMD) $(LINUX_CXX) $(LINUX_CXX_FLAGS) $(LINUX_LD_FLAGS) $(LINUX_LIBS) -o $@ $(LINUX_BUILD_DIR)/$(@F)-linux.o $(DYNAMIC_LINUX_LIBRARIES:%=-l%) $(DYNAMIC_EXECUTABLE_LIBRARIES:%=-l%)
endif
