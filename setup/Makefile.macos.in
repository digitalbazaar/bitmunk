# This file contains MacOSX-specific Makefile rules for building
# platform-specific binaries and packages.

# MacOS-specific variables
MACOS_CXX = @MACOS_CXX@
MACOS_CXX_FLAGS = @CXXFLAGS@ -Wall -fPIC -DMACOS $(CXX_FLAGS) $(MODULE_MACOS_CXX_FLAGS) @DEFS@
MACOS_LD_FLAGS = @LDFLAGS@ -Wl,-dylib_compatibility_version,@FULL_DOTTED_VERSION@ -Wl,-dylib_current_version,@FULL_DOTTED_VERSION@ -Wl,-flat_namespace $(LD_FLAGS)
MACOS_INCLUDES = $(INCLUDES) -I/sw/include
MACOS_DBLIB_DIR = $(MONARCH)/dist/lib
MACOS_LIB_DIR = $(MACOS_DIST_DIR)/lib
MACOS_LIBS = -L$(MACOS_DBLIB_DIR) -L$(MACOS_LIB_DIR) -L/sw/lib
MACOS_AR = @MACOS_AR@
MACOS_BUILD_DIR = $(BITMUNK)/build/$(subst $(BITMUNK)/cpp/,,$(CWD))
MACOS_DIST_DIR = $(BITMUNK)/dist
MACOS_BIN_DIR = $(MACOS_DIST_DIR)/bin
MACOS_XPT_DIR = $(MACOS_DIST_DIR)/xpt
MACOS_XPI_DIR = $(MACOS_DIST_DIR)/xpi
MACOS_MODULES_DIR = $(MACOS_DIST_DIR)/modules
MACOS_HEADER_FILES := $(patsubst %.h, $(BITMUNK)/$(HEADER_DIST_DIR)/%.h, $(HEADERS))
MACOS_LIBRARY_SOURCES := $(patsubst %.cpp,$(MACOS_BUILD_DIR)/%.cpp, $(SOURCES))
MACOS_EXECUTABLE_SOURCES := $(patsubst %,$(MACOS_BUILD_DIR)/%.cpp, $(EXECUTABLES))
LIBRARY_OBJECTS := $(patsubst %.cpp,$(MACOS_BUILD_DIR)/%-macos.o, $(SOURCES))
EXECUTABLE_OBJECTS := $(patsubst %,$(MACOS_BUILD_DIR)/%-macos.o, $(EXECUTABLES))
DYNAMIC_MACOS_LIBRARIES := $(DYNAMIC_LINK_LIBRARIES) $(DYNAMIC_MACOS_LIBRARIES)
MACOS_EXECUTABLES := $(patsubst %,$(MACOS_BIN_DIR)/%, $(EXECUTABLES))
MACOS_DEPENDENCIES := $(patsubst %.cpp,$(MACOS_BUILD_DIR)/%-macos.P, $(SOURCES))
MACOS_DEPENDENCIES += $(patsubst %.cpp,%-macos.P, $(MACOS_EXECUTABLE_SOURCES))

MACOS_LIBRARIES := $(patsubst %,$(MACOS_LIB_DIR)/lib%.dylib, $(LIBRARIES)) $(patsubst %,$(MACOS_LIB_DIR)/lib%.dylib, $(COMPONENT_LIBRARIES)) 
#MACOS_LIBRARIES += $(patsubst %,$(MACOS_DIST_DIR)/lib%.a, $(LIBRARIES))

ALL_GENERATED_HEADERS := $(patsubst %.idl,$(MACOS_BUILD_DIR)/%.h, $(IDL_SOURCES))
ALL_HEADERS += $(MACOS_HEADER_FILES)
ALL_XPTS := $(patsubst %.idl,$(MACOS_XPT_DIR)/%.xpt, $(IDL_SOURCES))
ALL_SOURCES += $(MACOS_LIBRARY_SOURCES) $(MACOS_EXECUTABLE_SOURCES)
ALL_OBJECTS += $(LIBRARY_OBJECTS) $(EXECUTABLE_OBJECTS)
ALL_LIBRARIES += $(MACOS_LIBRARIES)
ALL_EXECUTABLES += $(MACOS_EXECUTABLES)
ALL_DIRECTORIES += $(MACOS_BUILD_DIR) $(MACOS_DIST_DIR) $(MACOS_LIB_DIR) $(MACOS_BIN_DIR) $(MACOS_MODULES_DIR) $(MACOS_XPT_DIR) $(MACOS_XPI_DIR)

ifndef IGNORE_DEPENDENCIES
-include $(MACOS_DEPENDENCIES)
endif

$(MACOS_HEADER_FILES): 
	$(PCMD) mkdir -p $(dir $@)
	$(PCMD) ln -sf $(subst $(BITMUNK)/$(HEADER_DIST_DIR)/,$(CWD)/,$@) $@

# You can build either multiple executables per directory, or multiple
# libraries per directory, but not both.
ifdef EXECUTABLES
$(MACOS_EXECUTABLE_SOURCES):
	$(PCMD) mkdir -p $(dir $@)
	$(PCMD) ln -sf $(subst $(MACOS_BUILD_DIR)/,$(CWD)/,$@) $@
else
$(MACOS_LIBRARY_SOURCES):
	$(PCMD) mkdir -p $(dir $@)
	$(PCMD) ln -sf $(subst $(MACOS_BUILD_DIR)/,$(CWD)/,$@) $@
endif

$(MACOS_BUILD_DIR)/%.h: %.idl
	@echo "Building $@..."
	$(PCMD) $(XPIDL) -m header @XULRUNNER_IDL_FLAGS@ -o $(basename $@) $<

$(MACOS_XPT_DIR)/%.xpt: %.idl
	@echo "Generating dist/$(subst .P,.o,$(subst $(BITMUNK)/dist/,,$@))..."
	$(PCMD) $(XPIDL) -m typelib @XULRUNNER_IDL_FLAGS@ -o $(basename $@) $<

%-macos.o %-macos.P: %.cpp $(ALL_GENERATED_HEADERS)
	@echo "Compiling build/$(subst .P,.o,$(subst $(BITMUNK)/build/,,$@))..."
	$(PCMD) $(MACOS_CXX) $(MACOS_CXX_FLAGS) -c -MD -o $(basename $@).o $(MACOS_INCLUDES) -I. $(realpath $<)
	$(PCMD) cp $(basename $@).d $(basename $@).P; \
		sed -e 's/#.*//' -e 's/^[^:]*: *//' -e 's/ *\\$$//' -e '/^$$/ d' -e 's/$$/ :/' < $(basename $@).d >> $(basename $@).P; \
		rm -f $(basename $@).d

%.dylib: $(LIBRARY_OBJECTS)
	@echo "Linking $(subst $(BITMUNK)/,,$@)..."
	$(PCMD) $(MACOS_CXX) $(MACOS_LD_FLAGS) -install_name $(MACOS_LIB_DIR)/$(@F) $(MACOS_LIBS) -dynamiclib -o $@ $(LIBRARY_OBJECTS) $(DYNAMIC_MACOS_LIBRARIES:%=-l%)

ifdef EXECUTABLES
$(MACOS_EXECUTABLES): $(MACOS_BUILD_DIR)/$$(@F)-macos.o $(STATIC_MACOS_LIBRARIES)
	@echo "Linking dist/bin/$(@F)..."
	$(PCMD) $(MACOS_CXX) $(MACOS_CXX_FLAGS) $(MACOS_LD_FLAGS) $(MACOS_LIBS) -o $@ $(MACOS_BUILD_DIR)/$(@F)-macos.o $(DYNAMIC_MACOS_LIBRARIES:%=-l%) $(DYNAMIC_EXECUTABLE_LIBRARIES:%=-l%)

endif

